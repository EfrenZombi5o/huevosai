<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Minimal AI Assistant Chat</title>
<script src="https://js.puter.com/v2/"></script>
<style>
  :root {
    --bg-light: #f9f9f9;
    --bg-dark: #121212;
    --text-light: #222;
    --text-dark: #eee;
    --user-bubble-light: #d1e7ff;
    --assistant-bubble-light: #e9ecef;
    --user-bubble-dark: #2a4d7d;
    --assistant-bubble-dark: #444;
    --primary: #007bff;
    --primary-dark: #0056b3;
  }
  body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--bg-light);
    color: var(--text-light);
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  body.dark {
    background: var(--bg-dark);
    color: var(--text-dark);
  }
  #container {
    flex: 1;
    display: flex;
    flex-direction: column;
    max-width: 700px;
    margin: auto;
    border: 1px solid #ccc;
    border-radius: 8px;
    background: inherit;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }
  #chat {
    flex: 1;
    overflow-y: auto;
    padding: 1em;
    display: flex;
    flex-direction: column;
    gap: 0.75em;
  }
  .bubble {
    max-width: 70%;
    padding: 0.75em 1em;
    border-radius: 20px;
    line-height: 1.4;
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  .user {
    align-self: flex-end;
    background-color: var(--user-bubble-light);
    color: var(--text-light);
    border-bottom-right-radius: 4px;
  }
  .assistant {
    align-self: flex-start;
    background-color: var(--assistant-bubble-light);
    color: var(--text-light);
    border-bottom-left-radius: 4px;
  }
  body.dark .user {
    background-color: var(--user-bubble-dark);
    color: #cce4ff;
  }
  body.dark .assistant {
    background-color: var(--assistant-bubble-dark);
    color: var(--text-dark);
  }
  #input-area {
    display: flex;
    padding: 0.5em;
    border-top: 1px solid #ccc;
    background: inherit;
  }
  #prompt {
    flex: 1;
    padding: 0.5em 1em;
    font-size: 1em;
    border-radius: 20px;
    border: 1px solid #ccc;
    outline: none;
    resize: none;
    font-family: inherit;
    background: inherit;
    color: inherit;
  }
  #prompt:focus {
    border-color: var(--primary);
  }
  button {
    margin-left: 0.5em;
    padding: 0 1em;
    font-size: 1em;
    border-radius: 20px;
    border: none;
    background-color: var(--primary);
    color: white;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background-color: var(--primary-dark);
  }
  #controls {
    display: flex;
    justify-content: space-between;
    padding: 0.5em 1em;
    border-top: 1px solid #ccc;
    background: inherit;
  }
  select, input[type="text"] {
    font-size: 1em;
    padding: 0.3em 0.5em;
    border-radius: 6px;
    border: 1px solid #ccc;
    background: inherit;
    color: inherit;
  }
  body.dark select, body.dark input[type="text"] {
    border-color: #555;
  }
  #darkModeToggle {
    cursor: pointer;
    background: none;
    border: none;
    font-size: 1.2em;
    color: var(--primary);
  }
  #darkModeToggle:hover {
    color: var(--primary-dark);
  }
  #status {
    font-size: 0.9em;
    color: gray;
    padding: 0 1em 0.5em;
    min-height: 1.2em;
  }
  #imageUrl {
    width: 100%;
    margin-top: 0.5em;
    margin-bottom: 0.5em;
  }
</style>
</head>
<body>

<div id="container">
  <div id="chat"></div>

  <div id="status"></div>

  <div id="input-area">
    <textarea id="prompt" rows="2" placeholder="Type your message..."></textarea>
    <button id="voiceInputBtn" title="Voice Input">üé§</button>
    <button id="sendBtn" title="Send Message">‚û°Ô∏è</button>
  </div>

  <div id="controls">
    <input type="text" id="imageUrl" placeholder="Optional image URL to analyze" />
    <select id="modelSelect" title="Select AI Model">
      <optgroup label="DeepSeek Models">
        <option value="deepseek-chat">DeepSeek Chat (DeepSeek V3)</option>
        <option value="deepseek-reasoner">DeepSeek Reasoner (DeepSeek R1)</option>
      </optgroup>
      <optgroup label="Gemini Models">
        <option value="google/gemini-2.5-pro-exp-03-25:free">Gemini 2.5 Pro</option>
        <option value="google/gemini-2.0-flash-lite-001">Gemini 2.0 Flash Lite</option>
        <option value="google/gemini-flash-1.5-8b">Gemini 1.5 Flash</option>
      </optgroup>
      <optgroup label="OpenAI-Compatible Models">
        <option value="gpt-4o">GPT-4o</option>
        <option value="gpt-4.1">GPT-4.1</option>
        <option value="o3-mini">o3-mini</option>
        <option value="o1-mini">o1-mini</option>
        <option value="gpt-4.5-preview">GPT-4.5 Preview</option>
      </optgroup>
    </select>
    <button id="generateImageBtn" title="Generate Image">üñºÔ∏è</button>
    <button id="darkModeToggle" title="Toggle Dark Mode">üåô</button>
  </div>
</div>

<script>
  const chatDiv = document.getElementById('chat');
  const promptInput = document.getElementById('prompt');
  const sendBtn = document.getElementById('sendBtn');
  const voiceInputBtn = document.getElementById('voiceInputBtn');
  const imageUrlInput = document.getElementById('imageUrl');
  const modelSelect = document.getElementById('modelSelect');
  const generateImageBtn = document.getElementById('generateImageBtn');
  const darkModeToggle = document.getElementById('darkModeToggle');
  const statusDiv = document.getElementById('status');

  let recognition = null;
  let isListening = false;
  let synth = window.speechSynthesis;

  // Chat history in memory (no multi-chat for minimal version)
  let messages = [];

  function addMessage(role, text) {
    messages.push({role, text});
    if (messages.length > 50) messages.shift(); // keep last 50
    renderMessages();
  }

  function renderMessages() {
    chatDiv.innerHTML = '';
    messages.forEach(msg => {
      const bubble = document.createElement('div');
      bubble.className = 'bubble ' + msg.role;
      bubble.textContent = msg.text;
      chatDiv.appendChild(bubble);
    });
    chatDiv.scrollTop = chatDiv.scrollHeight;
  }

  async function sendQuery() {
    const prompt = promptInput.value.trim();
    const imageUrl = imageUrlInput.value.trim();
    const model = modelSelect.value;

    if (!prompt && !imageUrl) {
      alert('Please enter a message or image URL.');
      return;
    }

    addMessage('user', prompt || '[Image URL provided]');
    promptInput.value = '';
    statusDiv.textContent = 'Thinking...';

    try {
      let responseStream;
      if (imageUrl) {
        const fullPrompt = prompt || 'Describe this image';
        responseStream = await puter.ai.chat(fullPrompt, imageUrl, {model, stream: true});
      } else {
        responseStream = await puter.ai.chat(prompt, {model, stream: true});
      }

      let assistantReply = '';
      addMessage('assistant', ''); // placeholder bubble
      const bubbles = chatDiv.querySelectorAll('.assistant');
      const assistantBubble = bubbles[bubbles.length - 1];

      for await (const part of responseStream) {
        if (part?.text) {
          assistantReply += part.text;
          assistantBubble.textContent = assistantReply;
          chatDiv.scrollTop = chatDiv.scrollHeight;
        }
      }
      statusDiv.textContent = 'Done.';
      speakText(assistantReply);
    } catch (e) {
      statusDiv.textContent = 'Error: ' + e.message;
    }
  }

  async function generateImage() {
    const prompt = promptInput.value.trim();
    if (!prompt) {
      alert('Enter prompt to generate image.');
      return;
    }
    statusDiv.textContent = 'Generating image...';
    try {
      const img = await puter.ai.txt2img(prompt);
      addMessage('user', prompt);
      addMessage('assistant', '[Image generated below]');
      renderMessages();
      const imgElem = document.createElement('img');
      imgElem.src = img.src;
      imgElem.style.maxWidth = '100%';
      chatDiv.appendChild(imgElem);
      chatDiv.scrollTop = chatDiv.scrollHeight;
      statusDiv.textContent = 'Image generated.';
      promptInput.value = '';
    } catch (e) {
      statusDiv.textContent = 'Error generating image.';
    }
  }

  function setupVoiceRecognition() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
      voiceInputBtn.disabled = true;
      voiceInputBtn.title = 'Voice input not supported';
      return;
    }
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onstart = () => {
      isListening = true;
      voiceInputBtn.textContent = 'üéôÔ∏è Listening...';
      statusDiv.textContent = 'Listening...';
    };
    recognition.onend = () => {
      isListening = false;
      voiceInputBtn.textContent = 'üé§';
      statusDiv.textContent = '';
    };
    recognition.onerror = (e) => {
      statusDiv.textContent = 'Voice input error: ' + e.error;
      isListening = false;
      voiceInputBtn.textContent = 'üé§';
    };
    recognition.onresult = (e) => {
      const transcript = e.results[0][0].transcript;
      promptInput.value = transcript;
      statusDiv.textContent = 'You said: ' + transcript;
    };
  }

  function toggleVoiceInput() {
    if (!recognition) return;
    if (isListening) recognition.stop();
    else recognition.start();
  }

  function speakText(text) {
    if (!synth) return;
    if (synth.speaking) synth.cancel();
    if (!text) return;
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-US';
    synth.speak(utterance);
  }

  function toggleDarkMode() {
    document.body.classList.toggle('dark');
    if (document.body.classList.contains('dark')) {
      darkModeToggle.textContent = '‚òÄÔ∏è';
      localStorage.setItem('darkMode', 'true');
    } else {
      darkModeToggle.textContent = 'üåô';
      localStorage.setItem('darkMode', 'false');
    }
  }

  function loadDarkMode() {
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark');
      darkModeToggle.textContent = '‚òÄÔ∏è';
    } else {
      darkModeToggle.textContent = 'üåô';
    }
  }

  // Event listeners
  sendBtn.addEventListener('click', sendQuery);
  generateImageBtn.addEventListener('click', generateImage);
  voiceInputBtn.addEventListener('click', toggleVoiceInput);
  darkModeToggle.addEventListener('click', toggleDarkMode);

  promptInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendQuery();
    }
  });

  // Initialize
  setupVoiceRecognition();
  loadDarkMode();
</script>

</body>
</html>
